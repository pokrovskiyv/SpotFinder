# Распознавание намерений v2.0: Полностью на LLM

## Философия подхода

**Regex - это прошлое. LLM - это будущее.**

Вместо поддержки сложных regex паттернов, мы полностью полагаемся на возможности Gemini AI для понимания естественного языка.

## Почему без regex?

### ❌ Проблемы regex подхода:
- Жесткие паттерны, которые нужно постоянно обновлять
- Не понимают синонимы автоматически
- Требуют поддержки для каждого нового случая
- Сложно покрыть все формулировки
- Ошибки в regex приводят к неработающему распознаванию

### ✅ Преимущества LLM подхода:
- **Gemini понимает контекст** - "промочил ноги" → обувь без regex
- **Работает с любыми формулировками** автоматически
- **Понимает синонимы** без дополнительной настройки
- **Адаптируется** к новым запросам без изменения кода
- **Проще поддерживать** - только промпты, не код

## Как это работает

### 1. Улучшенные промпты (system-prompts.ts)

Вместо regex мы используем детальные примеры в промптах:

```typescript
ФИЗИЧЕСКИЕ ПРОБЛЕМЫ → МАГАЗИНЫ (НЕ ОТЕЛИ!):
- "промочил ноги" / "промокла обувь" / "вымок под дождем" / "мокрые ноги" → ОБУВНЫЕ МАГАЗИНЫ
❌ НИКОГДА НЕ ПРЕДЛАГАЙ ОТЕЛИ/ГОСТИНИЦЫ для этих проблем!
```

### 2. Антипаттерны

Четко указываем, что **НЕ** предлагать:

```typescript
КРИТИЧЕСКИ ВАЖНО - АНТИПАТТЕРНЫ:
❌ НЕ предлагай отели/гостиницы для физических проблем (промокли ноги, замерз, устал)
❌ НЕ предлагай жилье для бытовых нужд (голоден, нужен туалет, зарядить телефон)
❌ НЕ предлагай рестораны для здоровья (заболел, нужно лекарство)
```

### 3. Google Maps Grounding

Gemini использует Google Maps Grounding для поиска мест с учетом:
- Семантического понимания запроса
- Анализа отзывов
- Характеристик мест
- Геолокации

## Архитектура

```
Запрос пользователя: "промочил ноги"
    ↓
Gemini AI + улучшенные промпты
    ↓
Понимание: физическая проблема → нужна обувь
    ↓
Google Maps Grounding
    ↓
Поиск обувных магазинов
    ↓
Результат: список обувных магазинов ✅
```

## Ключевые файлы

### 1. `system-prompts.ts`
**Единственное место для настройки распознавания.**

Содержит:
- Базовые правила (`BASE`)
- Понимание неявных намерений (`INTENT_UNDERSTANDING`)
- Примеры запросов и правильных ответов
- Антипаттерны (что НЕ предлагать)
- Контекстные режимы (срочность, исследование, маршруты)

### 2. `orchestrator.ts`
Просто передает запрос в Gemini **без предобработки**:

```typescript
// No preprocessing - let Gemini AI handle intent recognition
geminiResponse = await this.geminiClient.search({
  query,  // Оригинальный запрос
  location,
  userId,
  context: preferences,
  isRouteRequest: wantsMultiplePlaces,
});
```

### 3. `gemini-client.ts`
Строит промпт с учетом:
- Времени суток
- Срочности запроса
- Предыдущего контекста
- Предпочтений пользователя

## Тестирование

### Примеры запросов, которые должны работать:

**Физические проблемы:**
```
✅ "промочил ноги" → обувь
✅ "промокла обувь" → обувь
✅ "вымок под дождем" → обувь/одежда
✅ "замерз" → одежда
✅ "мокрые ноги" → обувь
```

**Здоровье:**
```
✅ "заболел" → аптеки
✅ "плохо себя чувствую" → аптеки
✅ "болит голова" → аптеки
✅ "температура" → аптеки
```

**Технические:**
```
✅ "сел телефон" → кафе с розетками
✅ "разрядился телефон" → кафе/ТЦ
✅ "нужна зарядка" → кафе с розетками
```

**Бытовые:**
```
✅ "голодный" → еда
✅ "нужен туалет" → ТЦ/кафе
✅ "нужны деньги" → банкоматы
```

## Улучшение системы

### Когда бот ошибается:

1. **НЕ добавляйте regex!**
2. **Обновите промпты** в `system-prompts.ts`:
   - Добавьте больше примеров
   - Усильте антипаттерны
   - Уточните правила

### Пример добавления нового случая:

```typescript
// В INTENT_UNDERSTANDING добавьте:

НОВАЯ КАТЕГОРИЯ → РЕШЕНИЕ:
- "пример запроса 1" / "вариант 2" → что предложить
- "другая формулировка" → альтернатива
❌ НИКОГДА НЕ ПРЕДЛАГАЙ что-то неправильное для этого случая!
```

## Преимущества для пользователей

1. **Естественное общение** - можно писать как удобно
2. **Понимание контекста** - бот понимает намерения
3. **Синонимы работают** автоматически
4. **Опечатки прощаются** - LLM исправляет автоматически
5. **Новые формулировки** работают без обновлений

## Производительность

### Кеширование
- Gemini API кеширует популярные запросы
- Повторные запросы возвращаются мгновенно
- Cost tracking предотвращает перерасход

### Quota Management
- Автоматическое отслеживание лимитов
- Fallback на кеш при превышении квоты
- Per-user и глобальные лимиты

## Мониторинг

### Логи Supabase Functions
```
https://supabase.com/dashboard/project/YOUR_PROJECT_ID/logs/edge-logs
```

Смотрите на:
- Запросы пользователей
- Ответы Gemini
- Найденные места
- Ошибки распознавания

### Анализ ошибок

Если бот предлагает не то:
1. Посмотрите логи Gemini
2. Проверьте, какие примеры в промптах
3. Усильте антипаттерны
4. Добавьте больше контекста в промпты

## Развертывание

```powershell
# Просто разверните - всё работает через промпты
npx supabase@latest functions deploy telegram-webhook
```

Нет regex = нет сложностей!

## Сравнение подходов

| Аспект | Regex подход ❌ | LLM подход ✅ |
|--------|----------------|---------------|
| Гибкость | Жесткие паттерны | Понимает любые формулировки |
| Поддержка | Сложная, нужен код | Простая, только промпты |
| Синонимы | Нужно добавлять вручную | Автоматически |
| Опечатки | Не работают | Прощаются |
| Новые случаи | Нужно обновлять код | Работают сразу |
| Контекст | Не понимает | Понимает |
| Производительность | Быстро, но негибко | Быстро с кешем |

## Заключение

**Простота > Сложность**

Gemini AI уже умеет понимать естественный язык лучше любого regex. Зачем усложнять?

Вместо поддержки сотен regex паттернов, мы просто пишем хорошие промпты с примерами.

**Результат:** 
- Меньше кода
- Больше гибкости  
- Проще поддержка
- Лучше для пользователей

---

**Документация v1 (с regex):** [INTENT_RECOGNITION_TESTING.md](./INTENT_RECOGNITION_TESTING.md) (устарела)  
**Текущая версия:** v2.0 (только LLM)

