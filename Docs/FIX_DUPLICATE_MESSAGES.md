# Исправление дублирования сообщений при пагинации

## Проблема
Бот показывал одни и те же места несколько раз при нажатии кнопки "Показать еще", что приводило к дублированию сообщений.

## Причина
1. **Недостаточная дедупликация**: места с разными `place_id` но одинаковыми координатами считались разными
2. **Слабая фильтрация**: при пагинации не проверялось, были ли места уже показаны ранее
3. **Повторный показ из кеша**: кешированные места не фильтровались по уже показанным

## Решение

### 1. Новые утилиты дедупликации (`utils.ts`)

Добавлены функции для умной проверки дубликатов:

- **`arePlacesDuplicate(place1, place2)`** - проверяет дубликаты по:
  - `place_id` (если оба валидные)
  - Координатам (если расстояние < 50 метров)

- **`deduplicatePlaces(places)`** - удаляет дубликаты из массива мест

- **`isPlaceShown(place, shownPlaces)`** - проверяет, было ли место уже показано

### 2. Улучшения в `handleSearchQuery` (orchestrator.ts)

```typescript
// Дедупликация результатов
sortedPlaces = deduplicatePlaces(sortedPlaces);

// Фильтрация уже показанных мест
sortedPlaces = sortedPlaces.filter(place => !isPlaceShown(place, lastResults));
```

### 3. Улучшения в пагинации `handleCallbackQuery` (orchestrator.ts)

**Кеш:**
```typescript
// Дедупликация кешированных мест
let uniquePlaces = deduplicatePlaces(cached.places);

// Фильтрация показанных
uniquePlaces = uniquePlaces.filter(place => !isPlaceShown(place, lastResults));
```

**Расширенный радиус поиска:**
```typescript
// Дедупликация новых мест
let uniquePlaces = deduplicatePlaces(places);

// Фильтрация уже показанных
uniquePlaces = uniquePlaces.filter(place => !isPlaceShown(place, lastResults));
```

## Результат

✅ Места больше не дублируются при пагинации
✅ Умная проверка по координатам и place_id
✅ Корректный подсчет показанных мест
✅ Улучшенные логи для отладки

## Измененные файлы

1. `supabase/functions/_shared/utils.ts` - добавлены утилиты дедупликации
2. `supabase/functions/_shared/orchestrator.ts` - улучшена логика фильтрации в:
   - `handleSearchQuery()` - основной поиск
   - `handleCallbackQuery()` - пагинация (action='next')

## Тестирование

Для проверки исправлений:
1. Сделайте поиск: "найди кафе с рейтингом больше 4.5"
2. Нажимайте "Показать еще" несколько раз
3. Убедитесь, что места не повторяются

Ожидаемое поведение:
- Каждое место показывается только один раз
- Счетчик "всего показано" корректно увеличивается
- При исчерпании уникальных мест показывается сообщение о завершении

