# –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö –º–µ—Å—Ç

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–£–ø—Ä–æ—â–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö –º–µ—Å—Ç: –≤–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã `user_shown_places` —Å 7-–¥–Ω–µ–≤–Ω—ã–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–æ–µ –ø–æ–ª–µ `shown_place_ids` –≤ —Ç–∞–±–ª–∏—Ü–µ `sessions`.

## –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

### –ò—Å—Ç–æ—Ä–∏—è = –°–µ—Å—Å–∏—è = –í–∞–ª–∏–¥–Ω–æ—Å—Ç—å –ª–æ–∫–∞—Ü–∏–∏ (~30 –º–∏–Ω—É—Ç)

- –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö –º–µ—Å—Ç —Ö—Ä–∞–Ω–∏—Ç—Å—è **—Ç–æ–ª—å–∫–æ –≤ —Ä–∞–º–∫–∞—Ö –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏**
- –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–ª–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –ª–æ–∫–∞—Ü–∏–∏ –∏—Å—Ç–æ—Ä–∏—è **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è**
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–∞ `/clear_history` - –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ò—Å—Ç–æ—Ä–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–æ–≤ –≤ —Ä–∞–º–∫–∞—Ö —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–∏—Å–∫–∞

## –ß—Ç–æ –±—ã–ª–æ —É–¥–∞–ª–µ–Ω–æ

1. ‚ùå **–¢–∞–±–ª–∏—Ü–∞ `user_shown_places`** - –±–æ–ª—å—à–µ –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è
2. ‚ùå **–§–∞–π–ª `shown-places-manager.ts`** - —É–¥–∞–ª—ë–Ω
3. ‚ùå **–ö–æ–º–∞–Ω–¥–∞ `/clear_history`** - –Ω–µ –Ω—É–∂–Ω–∞, –æ—á–∏—Å—Ç–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è
4. ‚ùå **–ü–∞—Ä–∞–º–µ—Ç—Ä "7 –¥–Ω–µ–π"** - —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –ª–∏–º–∏—Ç

## –ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

‚úÖ **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞** (—Ä–µ–π—Ç–∏–Ω–≥, —Ü–µ–Ω–∞, —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ, –æ—Ç–∫—Ä—ã—Ç–æ)
‚úÖ **–£–º–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –º–µ—Å—Ç**
‚úÖ **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤** (–¥–æ 20 –º–µ—Å—Ç)
‚úÖ **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã** (üí∞)

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### –ú–∏–≥—Ä–∞—Ü–∏—è `010_add_shown_places_history.sql`

**–ë—ã–ª–æ:**
```sql
CREATE TABLE user_shown_places (...);
ALTER TABLE sessions ADD COLUMN places_cache ...;
```

**–°—Ç–∞–ª–æ:**
```sql
-- –¢–æ–ª—å–∫–æ –ø–æ–ª—è –≤ sessions, –±–µ–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
ALTER TABLE sessions ADD COLUMN IF NOT EXISTS places_cache JSONB NULL;
ALTER TABLE sessions ADD COLUMN IF NOT EXISTS cache_query TEXT NULL;
ALTER TABLE sessions ADD COLUMN IF NOT EXISTS cache_index INT DEFAULT 0;
ALTER TABLE sessions ADD COLUMN IF NOT EXISTS shown_place_ids TEXT[] NULL;
```

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### 1. –¢–∏–ø—ã (`types.ts`)

**–£–¥–∞–ª–µ–Ω–æ:**
```typescript
export interface DBUserShownPlace { ... }
```

**–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ `DBSession`:**
```typescript
shown_place_ids: string[] | null;
```

### 2. SessionManager (`session-manager.ts`)

**–ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
- `addShownPlaceIds(userId, placeIds)` - –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∫–∞–∑–∞–Ω–Ω—ã–µ –º–µ—Å—Ç–∞
- `getShownPlaceIds(userId)` - –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö –º–µ—Å—Ç
- `clearShownPlaceIds(userId)` - –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é

**–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –º–µ—Ç–æ–¥:**
- `updateLocation()` - —Ç–µ–ø–µ—Ä—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç `shown_place_ids`, `places_cache`, `cache_query`, `cache_index`

### 3. Orchestrator (`orchestrator.ts`)

#### handleSearchQuery()
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `sessionManager.getShownPlaceIds()` –≤–º–µ—Å—Ç–æ `shownPlacesManager.getShownPlaces()`
- –î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–Ω—ã–µ –º–µ—Å—Ç–∞ —á–µ—Ä–µ–∑ `sessionManager.addShownPlaceIds()`

#### handleCallbackQuery() - "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë"
**–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —É–≤–µ–ª–∏—á–µ–Ω–∏–µ–º —Ä–∞–¥–∏—É—Å–∞:**

1. **–ï—Å—Ç—å –∫—ç—à** ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å –∏–∑ –∫—ç—à–∞, –¥–æ–±–∞–≤–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é
2. **–ö—ç—à –∑–∞–∫–æ–Ω—á–∏–ª—Å—è** ‚Üí –Ω–æ–≤—ã–π –ø–æ–∏—Å–∫ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ä–∞–¥–∏—É—Å–æ–º:
   - –ü–æ–ø—ã—Ç–∫–∞ 1: —Ä–∞–¥–∏—É—Å **10 –∫–º**
   - –ü–æ–ø—ã—Ç–∫–∞ 2: —Ä–∞–¥–∏—É—Å **20 –∫–º**
   - –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ: —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏ –¥–æ —Å–±—Ä–æ—Å–∞ –∏—Å—Ç–æ—Ä–∏–∏

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –±–æ–ª—å—à–µ –º–µ—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è: "–ù–∞—à—ë–ª –µ—â—ë –º–µ—Å—Ç–∞ –≤ —Ä–∞–¥–∏—É—Å–µ 10 –∫–º! (–≤—Å–µ–≥–æ –ø–æ–∫–∞–∑–∞–Ω–æ: 15)"
- –ü—Ä–∏ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–∏ –º–µ—Å—Ç: –ø–æ–¥—Å–∫–∞–∑–∫–∞ –∫–æ–≥–¥–∞ –∏—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–∏—Ç—Å—è

### 4. GeminiClient (`gemini-client.ts`)

**–û–±–Ω–æ–≤–ª—ë–Ω –º–µ—Ç–æ–¥:**
```typescript
async searchNearbyPlaces(
  location: Location,
  query: string,
  maxResults: number = 5,
  radius: number = 5000  // –ù–û–í–´–ô –ü–ê–†–ê–ú–ï–¢–†
): Promise<PlaceResult[]>
```

### 5. –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥

**–î–æ–±–∞–≤–ª–µ–Ω –≤ `Orchestrator`:**
```typescript
private getLocationTimeLeft(session: DBSession | null): number {
  // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è –ª–æ–∫–∞—Ü–∏–∏ (–≤ –º–∏–Ω—É—Ç–∞—Ö)
}
```

## –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –û–±—ã—á–Ω—ã–π –ø–æ–∏—Å–∫
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–∫–∞—Ñ–µ —Ä—è–¥–æ–º"
2. –ë–æ—Ç: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 5 –º–µ—Å—Ç, –∫—ç—à–∏—Ä—É–µ—Ç 20
   shown_place_ids = [id1, id2, id3, id4, id5]

3. "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë" ‚Üí –∏–∑ –∫—ç—à–∞ (–µ—â—ë 5)
   shown_place_ids = [id1...id10]

4. "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë" (–∫—ç—à –∑–∞–∫–æ–Ω—á–∏–ª—Å—è)
   ‚Üí –ü–æ–∏—Å–∫ –≤ —Ä–∞–¥–∏—É—Å–µ 10 –∫–º —Å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º –ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö
   ‚Üí –ù–∞—à–ª–æ—Å—å 15 –Ω–æ–≤—ã—Ö ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å 5
   shown_place_ids = [id1...id15]
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –õ–æ–∫–∞—Ü–∏—è –æ–±–Ω–æ–≤–∏–ª–∞—Å—å
```
1. –ü—Ä–æ—à–ª–æ 30 –º–∏–Ω—É—Ç ‚Üí –ª–æ–∫–∞—Ü–∏—è –∏—Å—Ç–µ–∫–ª–∞
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤—É—é –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
3. SessionManager.updateLocation() –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
   - shown_place_ids = null
   - places_cache = null
   - cache_query = null
   - cache_index = 0
4. –°–ª–µ–¥—É—é—â–∏–π –ø–æ–∏—Å–∫ ‚Üí –∏—Å—Ç–æ—Ä–∏—è —Å–≤–µ–∂–∞—è
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ú–µ—Å—Ç–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å
```
1. –ü–æ–∏—Å–∫ –≤ —Ä–∞–¥–∏—É—Å–µ 5 –∫–º ‚Üí 10 –º–µ—Å—Ç
2. –ü–æ–∫–∞–∑–∞–ª–∏ –≤—Å–µ 10 —á–µ—Ä–µ–∑ "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë"
3. –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–∏—Å–∫–∞ –≤ 10 –∫–º ‚Üí 5 –Ω–æ–≤—ã—Ö
4. –ü–æ–∫–∞–∑–∞–ª–∏ 5, –≤—Å–µ–≥–æ 15
5. –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–∏—Å–∫–∞ –≤ 20 –∫–º ‚Üí 0 –Ω–æ–≤—ã—Ö
6. –ë–æ—Ç: "üòû –ü–æ–∫–∞–∑–∞–ª –≤—Å–µ 15 –∫–∞—Ñ–µ –≤ —Ä–∞–¥–∏—É—Å–µ 20 –∫–º.
   –ò—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ 12 –º–∏–Ω—É—Ç."
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —É–ø—Ä–æ—â—ë–Ω–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

1. ‚úÖ **–ù–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –ë–î** - –ø—Ä–æ—â–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
2. ‚úÖ **–ù–µ—Ç —Ñ–æ–Ω–æ–≤–æ–π –æ—á–∏—Å—Ç–∫–∏** —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π
3. ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å** –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ª–æ–∫–∞—Ü–∏–∏
4. ‚úÖ **–ù–µ –Ω—É–∂–Ω–∞ –∫–æ–º–∞–Ω–¥–∞** `/clear_history`
5. ‚úÖ **–ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞** - –∏—Å—Ç–æ—Ä–∏—è = —Å–µ—Å—Å–∏—è
6. ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–∞–¥–∏—É—Å–∞** –ø–æ–∏—Å–∫–∞
7. ‚úÖ **–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è** —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (—Ä–∞–¥–∏—É—Å, –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)
8. ‚úÖ **–ë—ã—Å—Ç—Ä–µ–µ —Ä–∞–±–æ—Ç–∞–µ—Ç** - –º–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î

## –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î
```bash
# –ß–µ—Ä–µ–∑ Supabase Dashboard –∏–ª–∏ CLI
supabase migration up

# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ psql/Supabase SQL Editor:
# –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ supabase/migrations/010_add_shown_places_history.sql
```

### 2. –ü–µ—Ä–µ—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å Edge Function
```bash
supabase functions deploy telegram-webhook
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É
- –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∏—Å–∫, –Ω–∞–∂–∞—Ç—å "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë" –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –±–æ—Ç —Ä–∞—Å—à–∏—Ä—è–µ—Ç —Ä–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞
- –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞—Ü–∏—é –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∏—Å—Ç–æ—Ä–∏—è —Å–±—Ä–æ—Å–∏–ª–∞—Å—å

## –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–µ—Å—Å–∏–∏ –Ω–µ –ø–æ—Å—Ç—Ä–∞–¥–∞—é—Ç
- –ü–æ–ª–µ `shown_place_ids` —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å `NULL` –∑–Ω–∞—á–µ–Ω–∏–µ–º
- –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –±—ã–ª–∞ —Ç–∞–±–ª–∏—Ü–∞ `user_shown_places`) –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ —É–¥–∞–ª–∏—Ç—å

