# Тестирование распознавания намерений (Intent Recognition)

## Обзор

Система распознавания намерений использует комбинированный подход:
1. **Intent Mapper** - словарь явных паттернов для гарантированной точности
2. **Улучшенные AI-промпты** - для гибкости и обработки новых запросов

## Архитектура

### Компоненты

- **`intent-mapper.ts`** - Модуль предобработки запросов с регулярными выражениями
- **`system-prompts.ts`** - Улучшенные промпты для Gemini с примерами и антипаттернами
- **`orchestrator.ts`** - Интеграция предобработки в поток обработки запросов
- **`gemini-client.ts`** - Передача распознанного намерения в AI-модель

### Поток обработки

```
Запрос пользователя
    ↓
Intent Mapper (словарь паттернов)
    ↓
Обработанный запрос → GeminiClient
    ↓
Улучшенный промпт с контекстом намерения
    ↓
Gemini API с Google Maps Grounding
    ↓
Результаты поиска
```

## Тестовые сценарии

### 1. Физические проблемы → Обувь/Одежда

#### ✅ Запрос: "Промочил ноги"
**Ожидаемый результат:**
- Intent: `need_footwear`
- Категория: `shopping`
- Предложение: Обувные магазины поблизости
- **НЕ предлагать:** Отели, гостиницы

#### ✅ Запрос: "Промокла обувь"
**Ожидаемый результат:**
- Intent: `need_footwear`
- Категория: `shopping`
- Предложение: Обувные магазины

#### ✅ Запрос: "Вымок под дождем"
**Ожидаемый результат:**
- Intent: `need_footwear`
- Категория: `shopping`
- Предложение: Обувные/одежда магазины

#### ✅ Запрос: "Замерз"
**Ожидаемый результат:**
- Intent: Одежда (если добавлен паттерн) или обработка через AI
- Предложение: Магазины одежды
- **НЕ предлагать:** Отели, кафе (только если нет прямого упоминания)

### 2. Здоровье → Аптеки

#### ✅ Запрос: "Заболел"
**Ожидаемый результат:**
- Intent: `need_pharmacy`
- Категория: `health`
- Предложение: Аптеки рядом, работающие сейчас
- **НЕ предлагать:** Рестораны, отели

#### ✅ Запрос: "Плохо себя чувствую"
**Ожидаемый результат:**
- Intent: `need_pharmacy`
- Категория: `health`
- Предложение: Аптеки

#### ✅ Запрос: "Болит голова"
**Ожидаемый результат:**
- Intent: `need_pharmacy`
- Категория: `health`
- Предложение: Аптеки с лекарствами

### 3. Технические проблемы → Кафе/ТЦ

#### ✅ Запрос: "Сел телефон"
**Ожидаемый результат:**
- Intent: `need_charging`
- Категория: `services`
- Предложение: Кафе с розетками и Wi-Fi, торговые центры
- **НЕ предлагать:** Отели

#### ✅ Запрос: "Разрядился телефон"
**Ожидаемый результат:**
- Intent: `need_charging`
- Категория: `services`
- Предложение: Кафе с розетками

#### ✅ Запрос: "Нужна розетка"
**Ожидаемый результат:**
- Intent: `need_charging`
- Категория: `services`
- Предложение: Кафе с Wi-Fi и розетками

### 4. Бытовые нужды

#### ✅ Запрос: "Голодный"
**Ожидаемый результат:**
- Intent: `need_food`
- Категория: `food`
- Предложение: Кафе и рестораны, быстрое обслуживание
- **НЕ предлагать:** Отели

#### ✅ Запрос: "Нужен туалет"
**Ожидаемый результат:**
- Intent: `need_restroom`
- Категория: `facilities`
- Предложение: Торговые центры, кафе с туалетами
- **НЕ предлагать:** Отели

#### ✅ Запрос: "Нужны деньги"
**Ожидаемый результат:**
- Intent: `need_cash`
- Категория: `finance`
- Предложение: Банкоматы и банки поблизости

### 5. Работа и отдых

#### ✅ Запрос: "Хочу поработать"
**Ожидаемый результат:**
- Intent: `need_workspace`
- Категория: `workspace`
- Предложение: Кафе с Wi-Fi и розетками, коворкинги

#### ✅ Запрос: "С детьми"
**Ожидаемый результат:**
- Intent: `with_children`
- Категория: `family`
- Предложение: Детские площадки, семейные кафе
- **НЕ предлагать:** Бары, ночные клубы

## Проверка логов

При работе системы в логах должны появляться следующие сообщения:

```
✓ Intent mapped: "промочил ноги" → "обувные магазины поблизости, открыто сейчас"
  Intent: need_footwear, Category: shopping
  Exclude types: lodging, hotel, hostel
```

## Ключевые антипаттерны

### ❌ НИКОГДА НЕ ПРЕДЛАГАТЬ:

1. **Отели/гостиницы** для:
   - Физических проблем (промокли ноги, замерз)
   - Бытовых нужд (голоден, нужен туалет, зарядить телефон)

2. **Рестораны/еду** для:
   - Проблем со здоровьем (заболел, нужно лекарство)

3. **Развлечения** для:
   - Срочных проблем (заболел, сел телефон)

## Добавление новых паттернов

### Формат паттерна в `intent-mapper.ts`:

```typescript
{
  patterns: [
    /регулярное\s+выражение/i,
    /другой\s+вариант/i,
  ],
  intent: 'unique_intent_name',
  suggestedQuery: 'улучшенный запрос для поиска',
  category: 'category_name',
  excludeTypes: ['lodging', 'hotel'], // Типы мест для исключения
  priority: 90, // Приоритет (выше = проверяется раньше)
}
```

### Рекомендации по приоритетам:

- **100**: Критические/срочные (туалет, физические проблемы)
- **95**: Здоровье (аптеки)
- **90**: Технические/финансовые
- **85**: Бытовые/стандартные
- **80**: Работа/отдых
- **75**: Дополнительные

## Мониторинг эффективности

Для проверки эффективности системы отслеживайте:

1. **Логи Intent Mapper**: Сколько запросов распознается через словарь
2. **Feedback пользователей**: Правильность предложенных мест
3. **Ошибки категоризации**: Когда предлагаются неправильные типы мест

## Расширение системы

### Для добавления нового типа намерения:

1. Добавить паттерн в `intent-mapper.ts` с примерами регулярных выражений
2. Добавить примеры в `INTENT_UNDERSTANDING` в `system-prompts.ts`
3. Указать типы мест для исключения (`excludeTypes`)
4. Протестировать различные формулировки запроса

### Пример: Добавление "Потерял кошелек"

```typescript
{
  patterns: [
    /потерял(?:а|и)?\s+кошел[её]к/i,
    /украли\s+кошел[её]к/i,
  ],
  intent: 'lost_wallet',
  suggestedQuery: 'полиция, отделение полиции поблизости',
  category: 'emergency',
  excludeTypes: ['lodging', 'restaurant'],
  priority: 100,
}
```

## Известные ограничения

1. **Регулярные выражения** - требуют точного совпадения паттерна
2. **Новые формулировки** - могут не попасть в словарь, обрабатываются через AI
3. **Многоязычность** - текущая версия оптимизирована для русского языка

## Дальнейшие улучшения

- [ ] Добавить поддержку английского языка
- [ ] Машинное обучение для автоматического распознавания новых паттернов
- [ ] A/B тестирование эффективности словаря vs. чистого AI
- [ ] Аналитика самых частых нераспознанных запросов

