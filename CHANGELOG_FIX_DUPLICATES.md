# Changelog - Исправление дублирования сообщений

## [Исправлено] - 2025-10-28

### Проблема
Бот показывал одни и те же места несколько раз при использовании кнопки "Показать еще", что создавало дублирующиеся сообщения и путало пользователей.

### Исправления

#### Добавлены новые утилиты в `utils.ts`:
- `arePlacesDuplicate()` - умная проверка дубликатов по place_id и координатам (точность ~50м)
- `deduplicatePlaces()` - удаление дубликатов из массива мест
- `isPlaceShown()` - проверка, было ли место уже показано пользователю

#### Улучшена логика в `orchestrator.ts`:

**handleSearchQuery:**
- ✅ Дедупликация результатов перед показом
- ✅ Фильтрация уже показанных мест из предыдущих результатов
- ✅ Улучшенное логирование для отладки

**handleCallbackQuery (пагинация):**
- ✅ Дедупликация кешированных мест
- ✅ Фильтрация показанных мест при выдаче из кеша
- ✅ Дедупликация и фильтрация при расширенном поиске (10км, 20км)
- ✅ Корректный подсчет общего количества показанных мест
- ✅ Улучшенная обработка случая, когда все уникальные места исчерпаны

### Технические детали

**Критерии дублирования:**
1. Одинаковый валидный `place_id`
2. Расстояние между координатами < 50 метров

**Порог расстояния:** 50 метров выбран как оптимальный баланс для определения одного и того же места (учитывает неточности GPS и разные входы в одно здание).

### Затронутые файлы
- `supabase/functions/_shared/utils.ts` (+55 строк)
- `supabase/functions/_shared/orchestrator.ts` (модифицировано ~50 строк)
- `Docs/FIX_DUPLICATE_MESSAGES.md` (новый файл с документацией)

### Для разработчиков

При добавлении новых источников данных о местах убедитесь, что используете:
```typescript
import { deduplicatePlaces, isPlaceShown } from './utils.ts';

// Дедупликация массива мест
const uniquePlaces = deduplicatePlaces(places);

// Фильтрация показанных
const newPlaces = places.filter(p => !isPlaceShown(p, shownPlaces));
```

### Следующие шаги
- Мониторинг логов для проверки эффективности дедупликации
- Возможная оптимизация порога расстояния на основе обратной связи пользователей

