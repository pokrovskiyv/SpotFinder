# üîß –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫ SpotFinder Bot

**–î–∞—Ç–∞:** 27 –æ–∫—Ç—è–±—Ä—è 2025  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
```
‚úÖ users - —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
‚úÖ sessions - —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
‚úÖ user_preferences - —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
‚úÖ search_history - —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
‚úÖ places_cache - —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
```

### 2. –°–µ–∫—Ä–µ—Ç—ã (Environment Variables)
```
‚úÖ TELEGRAM_BOT_TOKEN - —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
‚úÖ GEMINI_API_KEY - —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
‚úÖ GOOGLE_MAPS_API_KEY - —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
‚úÖ SUPABASE_URL - —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
‚úÖ SUPABASE_SERVICE_ROLE_KEY - —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
‚úÖ SUPABASE_ANON_KEY - —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
‚úÖ SUPABASE_DB_URL - —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
```

### 3. Edge Function
```
‚úÖ –§—É–Ω–∫—Ü–∏—è: telegram-webhook
‚úÖ –°—Ç–∞—Ç—É—Å: ACTIVE
‚úÖ –í–µ—Ä—Å–∏—è: 1
‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞: 2025-10-27 16:36:09 UTC
```

### 4. Telegram Webhook
```
‚úÖ URL: https://icnnwmjrprufrohiyfpm.supabase.co/functions/v1/telegram-webhook
‚úÖ pending_update_count: 0
‚úÖ allowed_updates: message, callback_query
‚úÖ –û—à–∏–±–æ–∫ –Ω–µ—Ç
```

---

## ‚ùì –¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª `/start` –≤ 17:38
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –≤ 17:38
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –≤ 17:39
- **–ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∏ –Ω–∞ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ**

**–°—Ç–∞—Ç—É—Å webhook:**
- `pending_update_count` = 0 (–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –∑–∞—Å—Ç—Ä—è–ª–∏ –≤ –æ—á–µ—Ä–µ–¥–∏)
- –ù–µ—Ç `last_error_message` (–Ω–µ—Ç —è–≤–Ω—ã—Ö –æ—à–∏–±–æ–∫ –æ—Ç Telegram)

---

## üîç –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Edge Function

**–ß–µ—Ä–µ–∑ Supabase Dashboard:**

1. –û—Ç–∫—Ä–æ–π—Ç–µ: https://supabase.com/dashboard/project/icnnwmjrprufrohiyfpm/logs/edge-logs
2. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `telegram-webhook`
3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 15 –º–∏–Ω—É—Ç
4. –ò—â–∏—Ç–µ –∑–∞–ø–∏—Å–∏ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∞–º–∏ 17:38‚Äì17:40

**–ß—Ç–æ –∏—Å–∫–∞—Ç—å:**
- ‚úÖ –ó–∞–ø–∏—Å–∏ "Received update" ‚Äî –∑–Ω–∞—á–∏—Ç webhook –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
- ‚ùå –ó–∞–ø–∏—Å–∏ —Å –æ—à–∏–±–∫–∞–º–∏ (–∫—Ä–∞—Å–Ω—ã–µ) ‚Äî –∑–Ω–∞—á–∏—Ç –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º–∞ –≤ –∫–æ–¥–µ
- ‚ùå –ü—É—Å—Ç—ã–µ –ª–æ–≥–∏ ‚Äî –∑–Ω–∞—á–∏—Ç webhook –≤–æ–æ–±—â–µ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—Ä—É—á–Ω—É—é

**–ß–µ—Ä–µ–∑ Dashboard:**

1. –û—Ç–∫—Ä–æ–π—Ç–µ: https://supabase.com/dashboard/project/icnnwmjrprufrohiyfpm/functions/telegram-webhook
2. –ù–∞–∂–º–∏—Ç–µ "Invoke"
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π payload:

```json
{
  "update_id": 123456789,
  "message": {
    "message_id": 1,
    "from": {
      "id": 123456,
      "is_bot": false,
      "first_name": "Test"
    },
    "chat": {
      "id": 123456,
      "type": "private"
    },
    "date": 1730048280,
    "text": "/start"
  }
}
```

4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–≤–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "ok": true
}
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ

**–ß–µ—Ä–µ–∑ SQL Editor:**

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å–æ–∑–¥–∞—é—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
SELECT * FROM users ORDER BY created_at DESC LIMIT 5;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å–æ–∑–¥–∞—é—Ç—Å—è –ª–∏ —Å–µ—Å—Å–∏–∏
SELECT * FROM sessions ORDER BY updated_at DESC LIMIT 5;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ–∏—Å–∫–∞
SELECT * FROM search_history ORDER BY timestamp DESC LIMIT 5;
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º:**
- –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü—ã –ø—É—Å—Ç—ã–µ ‚Üí —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–ª–∏ –ø–∞–¥–∞–µ—Ç –¥–æ –∑–∞–ø–∏—Å–∏ –≤ –ë–î
- –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ ‚Üí —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç—ã –≤ Telegram

---

## üêõ –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã

### –ü—Ä–∏—á–∏–Ω–∞ 1: –§—É–Ω–∫—Ü–∏—è –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –æ—Ç Telegram

**–ü—Ä–∏–∑–Ω–∞–∫–∏:**
- –õ–æ–≥–∏ –ø—É—Å—Ç—ã–µ
- –¢–∞–±–ª–∏—Ü—ã –ë–î –ø—É—Å—Ç—ã–µ
- `pending_update_count` = 0

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ webhook –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (—É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ ‚úÖ)
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ URL —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ
3. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π POST –∑–∞–ø—Ä–æ—Å –∫ —Ñ—É–Ω–∫—Ü–∏–∏

**–¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:**
```powershell
$body = @{
  update_id = 123456789
  message = @{
    message_id = 1
    from = @{
      id = 123456
      is_bot = $false
      first_name = "Test"
    }
    chat = @{
      id = 123456
      type = "private"
    }
    date = 1730048280
    text = "/start"
  }
} | ConvertTo-Json -Depth 10

Invoke-RestMethod -Uri "https://icnnwmjrprufrohiyfpm.supabase.co/functions/v1/telegram-webhook" `
  -Method Post `
  -ContentType "application/json" `
  -Body $body
```

### –ü—Ä–∏—á–∏–Ω–∞ 2: –§—É–Ω–∫—Ü–∏—è –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π

**–ü—Ä–∏–∑–Ω–∞–∫–∏:**
- –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω—ã –æ—à–∏–±–∫–∏
- –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å API –∫–ª—é—á–∞–º–∏
- –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –ë–î

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å API –∫–ª—é—á–µ–π:
   - Gemini API Key: https://aistudio.google.com/app/apikey
   - Google Maps API Key: https://console.cloud.google.com/apis/credentials
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —É Service Role Key –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ —Ç–∞–±–ª–∏—Ü—ã

### –ü—Ä–∏—á–∏–Ω–∞ 3: –§—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç—ã

**–ü—Ä–∏–∑–Ω–∞–∫–∏:**
- –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç "Received update"
- –î–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –ë–î
- –ù–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `TELEGRAM_BOT_TOKEN` –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ `telegram-client.ts`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏ –æ—Ç Telegram API

### –ü—Ä–∏—á–∏–Ω–∞ 4: JWT Authentication

**–ü—Ä–∏–∑–Ω–∞–∫–∏:**
- –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401 Unauthorized
- (–≠—Ç–æ –±—ã–ª–æ –≤ –Ω–∞—á–∞–ª–µ, –Ω–æ –º—ã —É–¥–∞–ª–∏–ª–∏ webhook –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–ª–∏)

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ Dashboard
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ JWT verification –æ—Ç–∫–ª—é—á–µ–Ω –¥–ª—è webhook
3. –ü–µ—Ä–µ—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Ñ—É–Ω–∫—Ü–∏—é —Å —Ñ–ª–∞–≥–æ–º `--no-verify-jwt`:

```powershell
npx supabase functions deploy telegram-webhook --no-verify-jwt
```

---

## üìù –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞)

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Edge Function** (—Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ!)
   - https://supabase.com/dashboard/project/icnnwmjrprufrohiyfpm/logs/edge-logs
   - –ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Üí —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
   - –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ ‚Üí —Å–º–æ—Ç—Ä–∏–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –æ—à–∏–±–∫—É

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö**
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å SQL –∑–∞–ø—Ä–æ—Å—ã –≤—ã—à–µ
   - –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ ‚Üí —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —á–∞—Å—Ç–∏—á–Ω–æ
   - –ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Üí —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

3. **–í—ã–∑–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –≤—Ä—É—á–Ω—É—é**
   - –ß–µ—Ä–µ–∑ Dashboard ‚Üí Invoke
   - –ò–ª–∏ —á–µ—Ä–µ–∑ PowerShell (—Å–∫—Ä–∏–ø—Ç –≤—ã—à–µ)
   - –°–º–æ—Ç—Ä–∏–º –Ω–∞ –æ—Ç–≤–µ—Ç –∏ –ª–æ–≥–∏

4. **–ü–µ—Ä–µ—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Ñ—É–Ω–∫—Ü–∏—é —Å --no-verify-jwt**
   - –ï—Å–ª–∏ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ –Ω–µ –ø–æ–º–æ–≥–ª–æ
   - –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å JWT authentication

---

## üÜò –ë—ã—Å—Ç—Ä–∞—è –ø–æ–º–æ—â—å

**–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:**

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ª–æ–≥–∏: https://supabase.com/dashboard/project/icnnwmjrprufrohiyfpm/logs/edge-logs
2. –ù–∞–π–¥–∏—Ç–µ –æ—à–∏–±–∫—É
3. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥
4. –ü–µ—Ä–µ—Ä–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ:
   ```powershell
   npx supabase functions deploy telegram-webhook
   ```

**–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å JWT:**

```powershell
npx supabase functions deploy telegram-webhook --no-verify-jwt
```

**–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å webhook:**

```powershell
$TOKEN = "8293206567:AAHhTdSzqSfdPCjIsSSQT0AbakebTZ_lX4c"
Invoke-RestMethod -Uri "https://api.telegram.org/bot$TOKEN/deleteWebhook" -Method Post -ContentType "application/json" -Body '{"drop_pending_updates":true}'
Invoke-RestMethod -Uri "https://api.telegram.org/bot$TOKEN/setWebhook" -Method Post -ContentType "application/json" -Body (@{url="https://icnnwmjrprufrohiyfpm.supabase.co/functions/v1/telegram-webhook"; allowed_updates=@("message", "callback_query")} | ConvertTo-Json)
```

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –û—Ç–∫—Ä–æ–π—Ç–µ –ª–æ–≥–∏ Edge Function –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ç–∞–º. –≠—Ç–æ –¥–∞—Å—Ç –Ω–∞–º –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å, –ø–æ—á–µ–º—É –±–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç.

